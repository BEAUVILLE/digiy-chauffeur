<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY DRIVER PRO ‚Äî Espace Chauffeur</title>
  <meta name="theme-color" content="#f59e0b" />
  <meta name="description" content="Espace Chauffeur DIGIY DRIVER ‚Äî 0% commission, terrain first." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      /* ‚òÄÔ∏è Soleil S√©n√©gal */
      --bg1:#fff7ed;     /* orange-50 */
      --bg2:#fffbeb;     /* amber-50 */
      --card:#ffffff;
      --ink:#0f172a;     /* slate-900 */
      --muted:#475569;   /* slate-600 */
      --line:#e2e8f0;    /* slate-200 */
      --shadow: 0 18px 50px rgba(15,23,42,.08);

      --brand:#f59e0b;   /* amber-500 */
      --brand2:#fb923c;  /* orange-400 */
      --ok:#16a34a;      /* green-600 */
      --warn:#f97316;    /* orange-500 */
      --bad:#ef4444;     /* red-500 */

      --r:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(245,158,11,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(251,146,60,.16), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100vh;
    }

    a{color:inherit}
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:22px 16px 40px;
    }

    /* Top bar */
    .top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(245,158,11,1), rgba(251,146,60,1));
      color:#111827;
      box-shadow: 0 12px 26px rgba(245,158,11,.25);
      font-weight:900;
      font-family: Outfit, Manrope, sans-serif;
    }
    .brand h1{
      font-family: Outfit, Manrope, sans-serif;
      font-size:18px;
      margin:0;
      line-height:1.1;
    }
    .brand p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:13px;
    }

    .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.7);
      border:1px solid var(--line);
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
      font-size:13px;
      color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--bad)}
    .dot.ok{background:var(--ok)}

    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
      transition:.15s transform ease, .15s opacity ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0px); opacity:.92}
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
    }
    .btn.danger{
      border:none;
      background: linear-gradient(135deg, #ef4444, #fb7185);
      color:#fff;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      background: rgba(255,255,255,.86);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
    }
    .card .hd h2{
      margin:0;
      font-family: Outfit, Manrope, sans-serif;
      font-size:16px;
    }
    .card .hd small{
      display:block;
      margin-top:4px;
      color:var(--muted);
    }

    .card .bd{ padding:14px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){
      .row{grid-template-columns: 1fr;}
    }

    label{
      display:block;
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus{
      border-color: rgba(245,158,11,.65);
      box-shadow: 0 0 0 4px rgba(245,158,11,.16);
    }

    .sep{height:1px;background:var(--line); margin:12px 0}

    .msg{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.7);
      color:var(--muted);
      font-size:13px;
    }
    .msg.ok{border-color: rgba(22,163,74,.30); background: rgba(22,163,74,.08); color:#14532d}
    .msg.bad{border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.08); color:#7f1d1d}

    /* Login box */
    .center{
      min-height: calc(100vh - 80px);
      display:grid;
      place-items:center;
      padding:20px 0 40px;
    }
    .login{
      width:min(520px, 100%);
    }
    .login .hero{
      padding:16px 16px 0;
    }
    .hero h2{
      margin:0;
      font-family:Outfit, Manrope, sans-serif;
      font-size:20px;
    }
    .hero p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.35;
    }

    .otpgrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .otpgrid{grid-template-columns: 1fr;}
    }

    /* Table */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
    }
    thead th{
      text-align:left;
      font-size:12px;
      padding:10px 10px;
      color:var(--muted);
      background: #fff7ed;
      border-bottom:1px solid var(--line);
      font-weight:900;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
    }
    tbody tr:last-child td{border-bottom:none}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:900;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
    }
    .b-ok{border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.10); color:#14532d}
    .b-warn{border-color: rgba(249,115,22,.25); background: rgba(249,115,22,.10); color:#7c2d12}
    .b-idle{border-color: rgba(71,85,105,.25); background: rgba(71,85,105,.08); color:#334155}

    .tiny{font-size:12px;color:var(--muted)}
    .right{display:flex; gap:10px; align-items:center; justify-content:flex-end}
    .stack{display:flex; gap:10px; flex-wrap:wrap}
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
    /* üîê SUPABASE ‚Äî D√âJ√Ä POS√â */
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

    // ‚úÖ Anti-boucle refresh pendant debug (tu peux remettre autoRefreshToken:true plus tard)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: false,
        persistSession: true,
        detectSessionInUrl: false,
        storageKey: "digiy-driver-auth"
      }
    });

    // --- Helpers
    const $ = (sel) => document.querySelector(sel);
    const fmtMoney = (n) => {
      const x = Number(n||0);
      return x.toLocaleString("fr-FR") + " F CFA";
    };
    const safe = (s) => (s||"").trim();

    function toast(sel, text, type=""){
      const el = document.querySelector(sel);
      if(!el) return;
      el.innerHTML = `<div class="msg ${type}">${text}</div>`;
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function isValidPhoneE164(phone){
      const p = String(phone||"").trim().replace(/\s+/g,"");
      return p.startsWith("+") && p.length >= 8;
    }

    // --- Fake "courses" (d√©mo terrain)
    const DEMO_TRIPS = [
      { id:"TRP-9A2", date:"Aujourd‚Äôhui", zone:"Saly Centre", client:"Client (priv√©)", amount:3500, status:"done" },
      { id:"TRP-7F1", date:"Hier", zone:"Ngaparou", client:"Client (priv√©)", amount:5000, status:"done" },
      { id:"TRP-3K8", date:"Avant-hier", zone:"Dakar Plateau", client:"Client (priv√©)", amount:15000, status:"pending" },
      { id:"TRP-1M4", date:"Semaine", zone:"Somone", client:"Client (priv√©)", amount:4000, status:"cancel" }
    ];

    // --- State
    let sessionUser = null;

    // --- UI renderers
    function renderLogin(messageHtml=""){
      $("#app").innerHTML = `
        <div class="wrap">
          <div class="top">
            <div class="brand">
              <div class="logo">ü¶Ö</div>
              <div>
                <h1>DIGIY DRIVER PRO</h1>
                <p>Connexion Chauffeur ‚Ä¢ 0% commission</p>
              </div>
            </div>
            <div class="actions">
              <span class="pill"><span class="dot"></span> Non connect√©</span>
            </div>
          </div>

          <div class="center">
            <div class="card login">
              <div class="hero">
                <h2>Bienvenue, Chauffeur ‚ú®</h2>
                <p>
                  Connexion par <b>t√©l√©phone</b> (OTP).<br/>
                  Terrain first, rapide, propre.
                </p>
              </div>
              <div class="bd">
                ${messageHtml ? `<div class="msg">${messageHtml}</div><div class="sep"></div>` : ""}

                <div class="row">
                  <div>
                    <label>T√©l√©phone (format international)</label>
                    <input id="phone" placeholder="+221771342889" inputmode="tel" autocomplete="tel" />
                    <div class="tiny" style="margin-top:6px">Ex: +2217xxxxxxx</div>
                  </div>
                  <div>
                    <label>Module</label>
                    <select id="module">
                      <option value="driver">DRIVER</option>
                      <option value="loc">LOC</option>
                      <option value="resto">RESTO</option>
                      <option value="market">MARKET</option>
                    </select>
                    <div class="tiny" style="margin-top:6px">Ici on est sur DRIVER.</div>
                  </div>
                </div>

                <div class="sep"></div>

                <div class="otpgrid">
                  <button class="btn primary" id="btnSendOtp">Envoyer le code OTP</button>
                  <div>
                    <label>Code OTP</label>
                    <input id="otp" placeholder="123456" inputmode="numeric" autocomplete="one-time-code" />
                  </div>
                </div>

                <div class="stack" style="margin-top:10px">
                  <button class="btn" id="btnVerify">Valider & entrer</button>
                  <button class="btn" id="btnHelp">Aide</button>
                </div>

                <div id="loginMsg" style="margin-top:10px"></div>

                <div class="sep"></div>
                <div class="tiny">
                  Si ton provider SMS n‚Äôest pas configur√©, utilise les <b>Test Phone Numbers</b> dans Supabase Auth.
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      $("#btnHelp").onclick = () => {
        $("#loginMsg").innerHTML = `
          <div class="msg">
            üß† Pour tester vite : Supabase ‚Üí <b>Auth ‚Üí Providers ‚Üí Phone</b><br/>
            - Test numbers : <b>221771342889=123456</b> (selon l‚ÄôUI)<br/>
            - Sur cette page tu tapes : <b>+221771342889</b><br/>
            - OTP : <b>123456</b><br/>
            Si tu as <b>500</b> sur /otp ‚Üí c‚Äôest c√¥t√© provider (Twilio/Supabase logs).
          </div>
        `;
      };

      $("#btnSendOtp").onclick = sendOtp;
      $("#btnVerify").onclick = verifyOtp;
    }

    function renderTripStatus(s){
      if(s==="done") return `<span class="badge b-ok">‚úÖ Termin√©</span>`;
      if(s==="pending") return `<span class="badge b-warn">‚è≥ En attente</span>`;
      if(s==="cancel") return `<span class="badge b-idle">üö´ Annul√©</span>`;
      return `<span class="badge b-idle">‚Äî</span>`;
    }

    function renderDashboard(profile){
      const connectedDot = `<span class="pill"><span class="dot ok"></span> Connect√©</span>`;
      const who = profile?.full_name || profile?.business_name || "Chauffeur DIGIY";
      const phone = profile?.phone || sessionUser?.phone || "‚Äî";

      $("#app").innerHTML = `
        <div class="wrap">
          <div class="top">
            <div class="brand">
              <div class="logo">ü¶Ö</div>
              <div>
                <h1>DIGIY DRIVER PRO</h1>
                <p>Espace Chauffeur ‚Ä¢ Paiement direct ‚Ä¢ 0% commission</p>
              </div>
            </div>
            <div class="actions">
              ${connectedDot}
              <button class="btn danger" id="btnLogout">D√©connexion</button>
            </div>
          </div>

          <div class="grid">
            <!-- Profil + r√©glages -->
            <div class="card">
              <div class="hd">
                <div>
                  <h2>Profil Chauffeur</h2>
                  <small>Nom, zone, disponibilit√©, tarifs ‚Äî modifiable.</small>
                </div>
                <div class="right">
                  <span class="badge b-ok">‚úÖ PRO</span>
                </div>
              </div>
              <div class="bd">
                <div class="msg ok">
                  üëã <b>${escapeHtml(who)}</b> ‚Ä¢ <span class="tiny">${escapeHtml(phone)}</span>
                </div>

                <div class="sep"></div>

                <div class="row">
                  <div>
                    <label>Nom affich√©</label>
                    <input id="full_name" value="${escapeHtml(profile?.full_name || "")}" placeholder="Ex: Lamine Chauffeur" />
                  </div>
                  <div>
                    <label>T√©l√©phone</label>
                    <input id="phone_ro" value="${escapeHtml(phone || "")}" disabled />
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Ville</label>
                    <input id="city" value="${escapeHtml(profile?.city || "Dakar")}" placeholder="Dakar" />
                  </div>
                  <div>
                    <label>Zone</label>
                    <input id="zone" value="${escapeHtml(profile?.zone || "Saly / Petite C√¥te")}" placeholder="Saly Centre" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Disponibilit√©</label>
                    <select id="status">
                      <option value="available">‚úÖ Disponible</option>
                      <option value="busy">‚è≥ En course</option>
                      <option value="offline">üåô Hors ligne</option>
                    </select>
                    <div class="tiny" style="margin-top:6px">Un client verra juste ‚ÄúDisponible / En course‚Äù.</div>
                  </div>
                  <div>
                    <label>Type v√©hicule</label>
                    <select id="vehicle_type">
                      <option value="car">üöó Voiture</option>
                      <option value="moto">üèçÔ∏è Moto</option>
                      <option value="van">üöê Van</option>
                    </select>
                  </div>
                </div>

                <div class="sep"></div>

                <h3 style="margin:0 0 8px;font-family:Outfit,Manrope,sans-serif;font-size:15px">Tarifs (terrain)</h3>
                <div class="row">
                  <div>
                    <label>Prix d√©part (prise en charge)</label>
                    <input id="fare_base" type="number" min="0" value="${Number(profile?.fare_base ?? 1500)}" />
                    <div class="tiny" style="margin-top:6px">${fmtMoney(profile?.fare_base ?? 1500)}</div>
                  </div>
                  <div>
                    <label>Prix / km</label>
                    <input id="fare_per_km" type="number" min="0" value="${Number(profile?.fare_per_km ?? 350)}" />
                    <div class="tiny" style="margin-top:6px">${fmtMoney(profile?.fare_per_km ?? 350)} / km</div>
                  </div>
                </div>

                <div class="stack" style="margin-top:12px">
                  <button class="btn primary" id="btnSave">Enregistrer</button>
                  <button class="btn" id="btnRefresh">Rafra√Æchir</button>
                </div>

                <div id="saveMsg" style="margin-top:10px"></div>

                <div class="sep"></div>
                <div class="tiny">
                  ‚öôÔ∏è Note : V2 = localStorage + tentative upsert DB si <b>driver_profiles</b> existe (sinon √ßa reste utilisable).
                </div>
              </div>
            </div>

            <!-- Courses / Activit√© -->
            <div class="card">
              <div class="hd">
                <div>
                  <h2>Activit√© (d√©mo)</h2>
                  <small>Historique des courses (mock) ‚Äî on branchera la table apr√®s.</small>
                </div>
                <div class="right">
                  <span class="badge b-idle">üßæ ${DEMO_TRIPS.length} entr√©es</span>
                </div>
              </div>
              <div class="bd">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>ID</th>
                      <th>Zone</th>
                      <th>Statut</th>
                      <th>Montant</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${DEMO_TRIPS.map(t => `
                      <tr>
                        <td>${escapeHtml(t.date)}</td>
                        <td><b>${escapeHtml(t.id)}</b></td>
                        <td>${escapeHtml(t.zone)}</td>
                        <td>${renderTripStatus(t.status)}</td>
                        <td><b>${fmtMoney(t.amount)}</b></td>
                      </tr>
                    `).join("")}
                  </tbody>
                </table>

                <div class="sep"></div>

                <div class="msg">
                  üîú Prochaine √©tape : on remplace le mock par ta table Supabase (courses/trips) + realtime.
                </div>

                <div class="sep"></div>

                <div class="stack">
                  <button class="btn" id="btnGoHub">Retour HUB</button>
                  <button class="btn" id="btnGoPublic">Voir ma fiche publique</button>
                </div>
                <div class="tiny" style="margin-top:8px">
                  Le bouton ‚Äúfiche publique‚Äù est pr√™t (route √† d√©finir), pas de 404 forc√©.
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // init selects
      $("#status").value = profile?.status || "available";
      $("#vehicle_type").value = profile?.vehicle_type || "car";

      // actions
      $("#btnLogout").onclick = logout;
      $("#btnSave").onclick = saveProfile;
      $("#btnRefresh").onclick = refreshProfile;

      $("#btnGoHub").onclick = () => {
        toast("#saveMsg", "‚ÑπÔ∏è Configure l‚ÄôURL HUB quand tu veux (dans le code).", "ok");
      };

      $("#btnGoPublic").onclick = () => {
        toast("#saveMsg", "‚ÑπÔ∏è Fiche publique √† brancher (route/slug).", "ok");
      };
    }

    // --- Auth (OTP) ‚Äî IMPORTANT: E.164 => avec "+"
    async function sendOtp(){
      const phone = safe($("#phone").value).replace(/\s+/g,"");

      if(!isValidPhoneE164(phone)){
        toast("#loginMsg", "‚ùå Mets le t√©l√©phone au format international (ex: +221...).", "bad");
        return;
      }

      toast("#loginMsg", "‚è≥ Envoi OTP‚Ä¶", "");
      try{
        const { error } = await supabase.auth.signInWithOtp({ phone });
        if(error){
          toast("#loginMsg", "‚ùå Erreur OTP : " + escapeHtml(error.message), "bad");
          return;
        }
        toast("#loginMsg", "‚úÖ OTP demand√©. (Test: 123456 si activ√© dans Supabase)", "ok");
      }catch(e){
        toast("#loginMsg", "‚ùå Exception : " + escapeHtml(e.message || e), "bad");
      }
    }

    async function verifyOtp(){
      const phone = safe($("#phone").value).replace(/\s+/g,"");
      const token = safe($("#otp").value);

      if(!phone || !token){
        toast("#loginMsg", "‚ùå T√©l√©phone + code OTP requis.", "bad");
        return;
      }
      if(!isValidPhoneE164(phone)){
        toast("#loginMsg", "‚ùå T√©l√©phone invalide (ex: +221...).", "bad");
        return;
      }

      toast("#loginMsg", "‚è≥ V√©rification‚Ä¶", "");
      try{
        const { data, error } = await supabase.auth.verifyOtp({
          phone,
          token,
          type: "sms"
        });

        if(error){
          toast("#loginMsg", "‚ùå OTP invalide : " + escapeHtml(error.message), "bad");
          return;
        }

        sessionUser = data?.user || null;
        toast("#loginMsg", "‚úÖ Connect√© ! Chargement‚Ä¶", "ok");
        await boot(true);
      }catch(e){
        toast("#loginMsg", "‚ùå Exception : " + escapeHtml(e.message || e), "bad");
      }
    }

    async function logout(){
      try{ await supabase.auth.signOut(); }catch(e){}
      sessionUser = null;
      renderLogin("D√©connect√© ‚úÖ");
    }

    // --- Profile storage strategy (V2)
    const LS_KEY = "digiy_driver_profile_v2";

    function getLocalProfile(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){
        return null;
      }
    }

    function setLocalProfile(p){
      try{
        localStorage.setItem(LS_KEY, JSON.stringify(p));
      }catch(e){}
    }

    async function loadProfile(){
      // 1) Local immediate
      const local = getLocalProfile() || {};
      const base = {
        full_name: local.full_name || "",
        phone: local.phone || (sessionUser?.phone || ""),
        city: local.city || "Dakar",
        zone: local.zone || "Saly / Petite C√¥te",
        status: local.status || "available",
        vehicle_type: local.vehicle_type || "car",
        fare_base: Number(local.fare_base ?? 1500),
        fare_per_km: Number(local.fare_per_km ?? 350)
      };

      // 2) Try DB (optional): table public.driver_profiles
      try{
        const userId = sessionUser?.id;
        if(!userId) return base;

        const { data, error } = await supabase
          .from("driver_profiles")
          .select("*")
          .eq("auth_user_id", userId)
          .maybeSingle();

        if(error) return base;

        if(data){
          const merged = {
            ...base,
            full_name: data.full_name ?? base.full_name,
            phone: data.phone ?? base.phone,
            city: data.city ?? base.city,
            zone: data.zone ?? base.zone,
            status: data.status ?? base.status,
            vehicle_type: data.vehicle_type ?? base.vehicle_type,
            fare_base: Number(data.fare_base ?? base.fare_base),
            fare_per_km: Number(data.fare_per_km ?? base.fare_per_km)
          };
          setLocalProfile(merged);
          return merged;
        }

        return base;
      }catch(e){
        return base;
      }
    }

    async function saveProfile(){
      const profile = {
        full_name: safe($("#full_name").value),
        phone: safe($("#phone_ro").value),
        city: safe($("#city").value),
        zone: safe($("#zone").value),
        status: $("#status").value,
        vehicle_type: $("#vehicle_type").value,
        fare_base: Number($("#fare_base").value || 0),
        fare_per_km: Number($("#fare_per_km").value || 0)
      };

      // local save always
      setLocalProfile(profile);

      // Try DB upsert if table exists
      try{
        const userId = sessionUser?.id;
        if(!userId){
          toast("#saveMsg", "‚úÖ Enregistr√© (local).", "ok");
          return;
        }

        const payload = {
          auth_user_id: userId,
          ...profile,
          updated_at: new Date().toISOString()
        };

        const { error } = await supabase
          .from("driver_profiles")
          .upsert(payload, { onConflict: "auth_user_id" });

        if(error){
          toast("#saveMsg", "‚úÖ Enregistr√© (local). DB pas pr√™te : " + escapeHtml(error.message), "ok");
          return;
        }

        toast("#saveMsg", "‚úÖ Enregistr√© (local + DB).", "ok");
      }catch(e){
        toast("#saveMsg", "‚úÖ Enregistr√© (local).", "ok");
      }
    }

    async function refreshProfile(){
      toast("#saveMsg", "‚è≥ Rafra√Æchissement‚Ä¶", "");
      const p = await loadProfile();
      renderDashboard(p);
      toast("#saveMsg", "‚úÖ OK.", "ok");
    }

    // --- Boot (SAFE: pas de getSession au chargement)
    async function boot(afterVerify=false){
      try{
        const { data, error } = await supabase.auth.getUser();

        if(error || !data?.user){
          sessionUser = null;
          renderLogin(afterVerify ? "Session non d√©tect√©e. R√©essaie." : "");
          return;
        }

        sessionUser = data.user;

        const profile = await loadProfile();
        renderDashboard(profile);

        // Listen auth changes
        supabase.auth.onAuthStateChange((_event, newSession) => {
          if(!newSession?.user){
            sessionUser = null;
            renderLogin("Session expir√©e. Reconnecte-toi.");
          }else{
            sessionUser = newSession.user;
          }
        });
      }catch(e){
        sessionUser = null;
        renderLogin("Erreur chargement. Recharge la page (Cmd+Shift+R).");
      }
    }

    // Start
    renderLogin("");
    boot();
  </script>
</body>
</html>
