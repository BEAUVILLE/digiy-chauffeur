<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY DRIVER ‚Äî Chauffeur (Realtime + GEO Ville)</title>
  <meta name="theme-color" content="#16a34a" />
  <meta name="description" content="DIGIY DRIVER Chauffeur ‚Äî courses en direct, filtrage ville & distance, 0% commission." />

  <style>
    :root{
      --green:#16a34a;
      --green2:#0f7a3a;
      --sky:#0ea5e9;
      --ok:#22c55e;
      --bg:#f7fbf8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --shadow: 0 10px 22px rgba(2,6,23,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #eafff3 0%, var(--bg) 40%, #ffffff 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      padding:14px;
      background: linear-gradient(90deg, var(--green), #22c55e);
      color:#fff;
      box-shadow: 0 10px 18px rgba(22,163,74,.25);
    }
    .topRow{
      display:flex; align-items:center; justify-content:space-between;
      max-width:980px; margin:0 auto; gap:10px;
    }
    .brand{
      font-weight:900; letter-spacing:.3px;
      display:flex; align-items:center; gap:10px; font-size:16px;
    }
    .pill{
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.25);
      padding:7px 10px; border-radius:999px;
      font-size:12px; font-weight:700;
      max-width: 46vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    main{max-width:980px; margin:0 auto; padding:14px;}
    .bar{
      background:#ffffffcc; backdrop-filter: blur(6px);
      border:1px solid rgba(15,23,42,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .field label{
      font-size:12px; color:var(--muted); font-weight:800; margin-bottom:6px; display:block;
    }
    select{
      width:100%; padding:10px; border-radius:12px;
      border:1px solid rgba(15,23,42,.12); font-size:14px;
      background:#fff;
      outline:none;
    }
    .status{
      margin-top:12px; padding:10px 12px;
      border-radius:14px; border:1px solid rgba(15,23,42,.08);
      background:#fff; display:flex; justify-content:space-between; gap:10px;
      box-shadow: var(--shadow);
      align-items:center;
    }
    .grid{
      margin-top:14px;
      display:grid; grid-template-columns: repeat(2,1fr); gap:12px;
    }
    @media(max-width:860px){
      .bar{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .pill{max-width:62vw}
    }
    .trip{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,.08);
      padding:14px;
    }
    .route{font-weight:900}
    .meta{
      margin-top:8px;
      display:flex; flex-wrap:wrap; gap:8px;
      font-size:12px; color:var(--muted);
      font-weight:700;
    }
    .tag{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
    }
    .price{margin-top:10px; font-size:16px; font-weight:1000; color:var(--green2)}
    .actions{display:flex; gap:10px; margin-top:12px}
    button{
      width:100%;
      padding:11px;
      border:none;
      border-radius:12px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      min-height:44px; /* mobile friendly */
      touch-action:manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-accept{background:var(--green); color:#fff}
    .btn-start{background:var(--sky); color:#fff}
    .btn-done{background:var(--ok); color:#fff}
    .toast{
      position:fixed;
      bottom:16px;
      bottom:calc(16px + env(safe-area-inset-bottom));
      left:50%;
      transform:translateX(-50%);
      background: rgba(15,23,42,.92);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      font-weight:800;
      display:none;
      max-width:92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      z-index:20;
    }
  </style>
</head>

<body>
<header>
  <div class="topRow">
    <div class="brand">üöï DIGIY DRIVER <span class="pill">GEO ‚Ä¢ Ville</span></div>
    <div class="pill" id="who">‚Ä¶</div>
  </div>
</header>

<main>
  <!-- Filtres GEO par VILLE -->
  <div class="bar">
    <div class="field">
      <label>üèôÔ∏è Ville (pickup_city)</label>
      <select id="cityFilter">
        <option value="">Toutes</option>
        <option value="Dakar">Dakar</option>
        <option value="Saly">Saly</option>
        <option value="Thi√®s">Thi√®s</option>
      </select>
    </div>

    <div class="field">
      <label>üìè Rayon</label>
      <select id="radiusFilter">
        <option value="3">3 km</option>
        <option value="5" selected>5 km</option>
        <option value="10">10 km</option>
      </select>
    </div>

    <div class="field">
      <label>üéõÔ∏è Vue</label>
      <select id="viewFilter">
        <option value="open" selected>Demandes ouvertes</option>
        <option value="mine">Mes courses</option>
        <option value="all">Tout</option>
      </select>
    </div>
  </div>

  <div class="status">
    <div>
      <strong id="statusTitle">Connexion‚Ä¶</strong><br>
      <small id="statusSub">Realtime actif</small>
    </div>
    <div class="pill" id="gpsBadge">GPS‚Ä¶</div>
  </div>

  <div class="grid" id="trips"></div>
</main>

<div class="toast" id="toast"></div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";

  /* ‚úÖ Ta vraie ANON KEY (pas de __ANON_KEY__) */
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  /* ‚úÖ Anti-doublon client */
  globalThis.__sb ||= createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const supabase = globalThis.__sb;

  const tripsEl = document.getElementById("trips");
  const cityFilter = document.getElementById("cityFilter");
  const radiusFilter = document.getElementById("radiusFilter");
  const viewFilter = document.getElementById("viewFilter");
  const whoEl = document.getElementById("who");
  const gpsBadge = document.getElementById("gpsBadge");
  const toastEl = document.getElementById("toast");
  const statusTitle = document.getElementById("statusTitle");
  const statusSub = document.getElementById("statusSub");

  let toastT = null;
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display="block";
    clearTimeout(toastT);
    toastT = setTimeout(()=>toastEl.style.display="none",2200);
  }

  /* AUTH */
  const { data: u, error: uerr } = await supabase.auth.getUser();
  if (uerr) console.warn(uerr);
  const user = u?.user;

  if (!user){
    statusTitle.textContent = "‚ùå Non connect√©";
    statusSub.textContent = "Passe par la page login OTP chauffeur, puis reviens ici.";
    whoEl.textContent = "Offline";
    throw new Error("Not authenticated");
  }

  whoEl.textContent = user.phone || user.email || "Chauffeur";
  statusTitle.textContent = "üü¢ En ligne";
  statusSub.textContent = "Realtime actif ‚Ä¢ attente de courses";

  /* GPS */
  let driverLat=null, driverLng=null;
  navigator.geolocation?.watchPosition(
    p=>{ driverLat=p.coords.latitude; driverLng=p.coords.longitude; gpsBadge.textContent="GPS OK"; },
    ()=>{ gpsBadge.textContent="GPS OFF"; },
    { enableHighAccuracy:true, maximumAge: 8000, timeout: 12000 }
  );

  function distanceKm(lat1,lon1,lat2,lon2){
    const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }

  /* STORE */
  const store=new Map();
  const ACTIVE = ["requested","accepted","ongoing"];

  function passesFilters(t){
    if (cityFilter.value && t.pickup_city!==cityFilter.value) return false;

    if (viewFilter.value==="open" && t.status!=="requested") return false;
    if (viewFilter.value==="mine" && !["accepted","ongoing"].includes(t.status)) return false;
    if (viewFilter.value==="all" && !ACTIVE.includes(t.status)) return false;

    if (driverLat && driverLng && t.pickup_lat && t.pickup_lng){
      if (distanceKm(driverLat,driverLng,t.pickup_lat,t.pickup_lng) > parseFloat(radiusFilter.value)) return false;
    }
    return true;
  }

  function render(){
    tripsEl.innerHTML="";

    const items = [...store.values()]
      .filter(passesFilters)
      .sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));

    if (!items.length){
      tripsEl.innerHTML = `
        <div class="trip" style="grid-column:1/-1">
          <div class="route">Aucune course pour tes filtres</div>
          <div class="meta">
            <span class="tag">Ville = Toutes</span>
            <span class="tag">Rayon = 10km</span>
            <span class="tag">Vue = Demandes ouvertes</span>
          </div>
        </div>`;
      return;
    }

    for (const t of items){
      const el=document.createElement("div");
      el.className="trip";

      const distTag = (driverLat && driverLng && t.pickup_lat && t.pickup_lng)
        ? `<span class="tag">üìè ${distanceKm(driverLat,driverLng,t.pickup_lat,t.pickup_lng).toFixed(1)} km</span>`
        : "";

      el.innerHTML=`
        <div class="route">üìç ${t.pickup_city || "?"} ‚Üí ${t.dropoff_city || "?"}</div>
        <div class="meta">
          <span class="tag">${t.pickup_city || "?"}</span>
          <span class="tag">${t.status || "?"}</span>
          ${distTag}
        </div>
        <div class="price">üí∞ ${Number(t.amount ?? 0).toLocaleString("fr-FR")} F CFA</div>
        <div class="actions">
          ${t.status==="requested"?`<button class="btn-accept" data-id="${t.id}" data-act="accept">Accepter</button>`:""}
          ${t.status==="accepted"?`<button class="btn-start" data-id="${t.id}" data-act="start">D√©marrer</button>`:""}
          ${t.status==="ongoing"?`<button class="btn-done" data-id="${t.id}" data-act="complete">Terminer</button>`:""}
        </div>`;
      tripsEl.appendChild(el);
    }
  }

  /* LOAD */
  async function load(){
    const { data, error } = await supabase.from("driver_trips")
      .select("*")
      .in("status", ACTIVE);

    if (error){
      console.error(error);
      statusTitle.textContent = "‚ö†Ô∏è Erreur";
      statusSub.textContent = "driver_trips inaccessible";
      toast("‚ùå Erreur chargement");
      return;
    }

    store.clear();
    data?.forEach(t => t?.id && store.set(t.id,t));
    render();
  }

  cityFilter.onchange = radiusFilter.onchange = viewFilter.onchange = render;
  await load();

  /* ACTIONS */
  async function rpcAction(act, id){
    if (!id) return;
    try{
      toast("‚è≥ Action‚Ä¶");

      let res;
      if(act === "accept") res = await supabase.rpc("accept_trip",{ p_trip_id:id });
      if(act === "start") res  = await supabase.rpc("start_trip",{ p_trip_id:id });
      if(act === "complete") res = await supabase.rpc("complete_trip",{ p_trip_id:id });

      if (res?.error){
        console.error(res.error);
        toast("‚ùå " + res.error.message);
        return;
      }

      toast("‚úÖ OK");
      await load(); // fiabilit√© max si realtime arrive en retard
    }catch(err){
      console.error(err);
      toast("‚ùå Erreur action");
    }
  }

  document.addEventListener("click", async (e)=>{
    const b = e.target.closest("button[data-act]");
    if(!b) return;
    rpcAction(b.dataset.act, b.dataset.id);
  });

  /* REALTIME */
  supabase.channel("driver-trips-live")
    .on("postgres_changes",{event:"INSERT",schema:"public",table:"driver_trips"}, p=>{
      const t = p.new;
      if (!t?.id) return;
      if (ACTIVE.includes(t.status)) store.set(t.id, t);
      render();
      if (t.status === "requested") toast("üöï Nouvelle demande !");
    })
    .on("postgres_changes",{event:"UPDATE",schema:"public",table:"driver_trips"}, p=>{
      const t = p.new;
      if (!t?.id) return;

      // ‚úÖ si la course sort de requested/accepted/ongoing => on enl√®ve
      if (ACTIVE.includes(t.status)) store.set(t.id, t);
      else store.delete(t.id);

      render();
    })
    .subscribe();
</script>
</body>
</html>
