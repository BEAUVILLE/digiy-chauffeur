<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DIGIY CHAUFFEUR PRO</title>

  <!-- Supabase (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Leaflet.js -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ‚úÖ Colle ton CSS ici */
    body{margin:0;background:#0A0E1A;color:#F1F5F9;font-family:system-ui}
    #map{height:280px;border-radius:16px;overflow:hidden;border:1px solid rgba(250,204,21,.18)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .badge{font-weight:900;color:#facc15}
    .btn{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn-outline{background:transparent;color:#e2e8f0;border:1px solid rgba(148,163,184,.25)}
    .btn-gold{background:#facc15;color:#111827}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(250,204,21,.14);border-radius:18px;padding:14px;margin-top:14px}
    .muted{opacity:.8}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="badge">‚àû DIGIY</div>
        <div class="muted">Chauffeur PRO</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnHub" class="btn btn-outline"><i class="fa-solid fa-house"></i> HUB</button>
        <button id="btnLogout" class="btn btn-outline"><i class="fa-solid fa-right-from-bracket"></i> D√©connexion</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900;font-size:18px;margin-bottom:6px">Tableau de bord</div>
      <div class="muted" id="who">Chargement‚Ä¶</div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin-bottom:10px">Carte (test)</div>
      <div id="map"></div>
    </div>
  </div>

  <script>
    /***********************
     * 1) CONFIG
     ***********************/
    const SUPABASE_URL = "https://TONPROJET.supabase.co";
    const SUPABASE_ANON_KEY = "TON_ANON_KEY";

    // Routes (adapte √† tes URLs GitHub Pages)
    // Exemple: driver-auth (porte) et digiy-chauffeur (maison)
    const URL_LOGIN = "https://beauville.github.io/driver-auth/";        // üîÅ mets ton vrai lien
    const URL_PAY   = "https://beauville.github.io/digiy-hub/paiements.html"; // üîÅ mets ton vrai lien
    const URL_HUB   = "https://beauville.github.io/digiy-hub/";          // üîÅ mets ton vrai lien

    const REQUIRED_ROLE = "pro";     // optionnel (si tu as role)
    const REQUIRED_MODULE = "driver"; // le module √† exiger

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * 2) OUTILS (UI blocage)
     ***********************/
    function redirect(to){
      // conserve next
      const u = new URL(to, location.href);
      if (!u.searchParams.get("next")) u.searchParams.set("next", location.pathname + location.search);
      location.href = u.toString();
    }

    function showBlock(title, msg, ctaText, ctaHref){
      const wrap = document.createElement("div");
      wrap.style.cssText = `
        position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
        background:rgba(0,0,0,.78);z-index:99999;padding:20px;
      `;
      wrap.innerHTML = `
        <div style="max-width:560px;width:100%;background:#0A0E1A;border:1px solid rgba(250,204,21,.25);
          border-radius:18px;padding:18px;color:#f1f5f9;font-family:system-ui">
          <div style="font-weight:900;font-size:18px;margin-bottom:6px">${title}</div>
          <div style="opacity:.92;line-height:1.45;margin-bottom:12px">${msg}</div>
          <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
            <a href="${ctaHref}" style="text-decoration:none;background:#facc15;color:#111827;
              padding:10px 14px;border-radius:12px;font-weight:900">${ctaText}</a>
            <button id="digiyClose" style="background:transparent;border:1px solid rgba(148,163,184,.25);
              color:#e2e8f0;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer">Fermer</button>
          </div>
        </div>
      `;
      document.body.appendChild(wrap);
      wrap.querySelector("#digiyClose").onclick = () => wrap.remove();
    }

    function normalizeModules(mods){
      if (!mods) return [];
      if (Array.isArray(mods)) return mods.map(x => String(x).toLowerCase());
      return String(mods).split(",").map(s => s.trim().toLowerCase()).filter(Boolean);
    }

    /***********************
     * 3) LOAD ACCESS (√† brancher √† TON sch√©ma)
     *
     * ‚úÖ Option A (reco) : VUE v_access_dashboard
     * Colonnes attendues :
     * - auth_user_id
     * - role
     * - status
     * - modules_actifs (array ou texte)
     ***********************/
    async function loadAccess(authUserId){
      const { data, error } = await supabase
        .from("v_access_dashboard")
        .select("*")
        .eq("auth_user_id", authUserId)
        .maybeSingle();

      if (error) return { access:null, error };
      return { access:data || null, error:null };
    }

    /***********************
     * 4) GUARD (Acc√®s r√©el)
     ***********************/
    async function guard(){
      const { data } = await supabase.auth.getSession();
      const session = data?.session || null;

      // 1) pas connect√© => porte (driver-auth)
      if (!session?.user?.id){
        redirect(URL_LOGIN);
        return { ok:false, reason:"no_session" };
      }

      // 2) charge l‚Äôacc√®s r√©el
      const authUserId = session.user.id;
      const { access, error } = await loadAccess(authUserId);

      if (error){
        showBlock("Erreur d‚Äôacc√®s", "Je n‚Äôarrive pas √† charger ton acc√®s r√©el. R√©essaie ou contacte l‚Äôadmin.", "Retour HUB", URL_HUB);
        return { ok:false, reason:"access_load_error", error };
      }

      if (!access){
        showBlock("Acc√®s non activ√©", "Ton compte est connect√©, mais aucun acc√®s n‚Äôest activ√© (abonnement / module).", "Activer maintenant", URL_PAY);
        return { ok:false, reason:"no_access" };
      }

      // 3) statut
      const status = String(access.status || "active").toLowerCase();
      if (!["active","enabled","ok"].includes(status)){
        showBlock("Compte en attente", "Ton compte est en cours de validation. D√®s que c‚Äôest OK, √ßa s‚Äôouvre.", "Retour HUB", URL_HUB);
        return { ok:false, reason:"status_not_active" };
      }

      // 4) role (si tu l‚Äôutilises)
      if (REQUIRED_ROLE){
        const role = String(access.role || "").toLowerCase();
        if (role && role !== REQUIRED_ROLE.toLowerCase()){
          showBlock("Acc√®s refus√©", "Tu n‚Äôas pas le bon r√¥le pour cette zone.", "Retour HUB", URL_HUB);
          return { ok:false, reason:"bad_role" };
        }
      }

      // 5) module
      if (REQUIRED_MODULE){
        const mods = normalizeModules(access.modules_actifs || access.modules || access.modules_active);
        if (!mods.includes(REQUIRED_MODULE.toLowerCase())){
          showBlock("Module non actif", `Le module <b>${REQUIRED_MODULE}</b> n‚Äôest pas actif sur ton compte.`, "Activer le module", URL_PAY);
          return { ok:false, reason:"module_inactive" };
        }
      }

      return { ok:true, session, access };
    }

    /***********************
     * 5) APP START
     ***********************/
    (async function start(){
      // boutons
      document.getElementById("btnHub").onclick = () => location.href = URL_HUB;
      document.getElementById("btnLogout").onclick = async () => {
        await supabase.auth.signOut();
        redirect(URL_LOGIN);
      };

      // ‚úÖ GUARD FIRST
      const g = await guard();
      if (!g.ok) return;

      // Page autoris√©e
      document.getElementById("who").innerHTML =
        `Connect√©: <b>${(g.access.full_name || g.access.business_name || "Chauffeur")}</b> ‚Ä¢ module: <b>${REQUIRED_MODULE}</b>`;

      // Map test (si ok)
      const map = L.map('map').setView([14.6928, -17.4467], 12); // Dakar par d√©faut
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
    })();
  </script>
</body>
</html>
