<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY DRIVER PRO ‚Äî Espace Chauffeur</title>
  <meta name="theme-color" content="#f59e0b" />
  <meta name="description" content="Espace Chauffeur DIGIY DRIVER ‚Äî 0% commission, terrain first." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      /* ‚òÄÔ∏è Soleil S√©n√©gal */
      --bg1:#fff7ed; --bg2:#fffbeb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --shadow: 0 18px 50px rgba(15,23,42,.08);

      --brand:#f59e0b;
      --brand2:#fb923c;
      --ok:#16a34a;
      --warn:#f97316;
      --bad:#ef4444;

      --r:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(245,158,11,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(251,146,60,.16), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100vh;
    }

    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:22px 16px 40px;}

    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px;}
    .brand{display:flex;align-items:center;gap:10px;user-select:none;}
    .logo{
      width:44px;height:44px;border-radius:14px;display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(245,158,11,1), rgba(251,146,60,1));
      color:#111827;box-shadow: 0 12px 26px rgba(245,158,11,.25);
      font-weight:900;font-family: Outfit, Manrope, sans-serif;
    }
    .brand h1{font-family: Outfit, Manrope, sans-serif;font-size:18px;margin:0;line-height:1.1;}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:13px;}

    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
      background: rgba(255,255,255,.7);border:1px solid var(--line);
      box-shadow: 0 10px 22px rgba(15,23,42,.06);font-size:13px;color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--bad)}
    .dot.ok{background:var(--ok)}

    .btn{
      border:1px solid var(--line);background:#fff;color:var(--ink);
      border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;
      box-shadow: 0 10px 18px rgba(15,23,42,.06);
      transition:.15s transform ease, .15s opacity ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0px); opacity:.92}
    .btn.primary{border:none;background: linear-gradient(135deg, var(--brand), var(--brand2));}
    .btn.danger{border:none;background: linear-gradient(135deg, #ef4444, #fb7185);color:#fff;}

    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px;}
    @media (max-width: 980px){.grid{grid-template-columns: 1fr;}}

    .card{
      background: rgba(255,255,255,.86);border:1px solid var(--line);
      border-radius: var(--r);box-shadow: var(--shadow);overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
    }
    .card .hd h2{margin:0;font-family: Outfit, Manrope, sans-serif;font-size:16px;}
    .card .hd small{display:block;margin-top:4px;color:var(--muted);}
    .card .bd{ padding:14px; }

    .row{display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    @media (max-width: 560px){.row{grid-template-columns: 1fr;}}

    label{display:block;font-size:12px;font-weight:800;color:var(--muted);margin:0 0 6px;}
    input, select{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);
      background:#fff;outline:none;font-size:14px;
    }
    input:focus, select:focus{border-color: rgba(245,158,11,.65);box-shadow: 0 0 0 4px rgba(245,158,11,.16);}
    .sep{height:1px;background:var(--line); margin:12px 0}

    .msg{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background: rgba(255,255,255,.7);color:var(--muted);font-size:13px;
    }
    .msg.ok{border-color: rgba(22,163,74,.30); background: rgba(22,163,74,.08); color:#14532d}
    .msg.bad{border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.08); color:#7f1d1d}

    .center{min-height: calc(100vh - 80px);display:grid;place-items:center;padding:20px 0 40px;}
    .login{width:min(520px, 100%);}
    .login .hero{padding:16px 16px 0;}
    .hero h2{margin:0;font-family:Outfit, Manrope, sans-serif;font-size:20px;}
    .hero p{margin:6px 0 0;color:var(--muted);font-size:14px;line-height:1.35;}

    .otpgrid{display:grid;grid-template-columns: 1.2fr .8fr;gap:10px;}
    @media (max-width: 520px){.otpgrid{grid-template-columns: 1fr;}}

    table{
      width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;
      border:1px solid var(--line);border-radius:14px;background:#fff;
    }
    thead th{
      text-align:left;font-size:12px;padding:10px 10px;color:var(--muted);
      background: #fff7ed;border-bottom:1px solid var(--line);font-weight:900;
    }
    tbody td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:13px;}
    tbody tr:last-child td{border-bottom:none}

    .badge{
      display:inline-flex;align-items:center;gap:6px;font-weight:900;border-radius:999px;
      padding:6px 10px;border:1px solid var(--line);background:#fff;font-size:12px;
    }
    .b-ok{border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.10); color:#14532d}
    .b-warn{border-color: rgba(249,115,22,.25); background: rgba(249,115,22,.10); color:#7c2d12}
    .b-idle{border-color: rgba(71,85,105,.25); background: rgba(71,85,105,.08); color:#334155}

    .tiny{font-size:12px;color:var(--muted)}
    .right{display:flex; gap:10px; align-items:center; justify-content:flex-end}
    .stack{display:flex; gap:10px; flex-wrap:wrap}
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
    /* üîê SUPABASE ‚Äî D√âJ√Ä POS√â */
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: false,
        persistSession: true,
        detectSessionInUrl: false,
        storageKey: "digiy-driver-auth"
      }
    });

    // --- Helpers
    const $ = (sel) => document.querySelector(sel);
    const fmtMoney = (n) => Number(n || 0).toLocaleString("fr-FR") + " F CFA";
    const safe = (s) => (s || "").trim();

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function toast(sel, text, type=""){
      const el = document.querySelector(sel);
      if(!el) return;
      el.innerHTML = `<div class="msg ${type}">${text}</div>`;
    }

    // ‚úÖ Validation souple: accepte +221... (prod) OU 221... (test)
    function isValidPhone(phone){
      const p = String(phone || "").trim().replace(/\s+/g, "");
      return ((p.startsWith("+") && p.length >= 8) || (!p.startsWith("+") && p.length >= 7));
    }
    function phoneNoPlus(phone){
      return String(phone || "").trim().replace(/\s+/g, "").replace(/^\+/, "");
    }
    function phoneE164(phone){
      const p = phoneNoPlus(phone);
      return p ? ("+" + p) : "";
    }

    // --- State
    let sessionUser = null;

    // ====== TRIPS (DB + REALTIME) ======
    let trips = [];
    let tripsChannel = null;

    function shortId(id){
      const s = String(id || "");
      return s ? s.slice(0,6) : "‚Äî";
    }

    function fmtDateLabel(iso){
      if(!iso) return "‚Äî";
      const d = new Date(iso);
      const now = new Date();
      const diff = Math.floor((now - d) / 86400000);
      if(diff === 0) return "Aujourd‚Äôhui";
      if(diff === 1) return "Hier";
      if(diff === 2) return "Avant-hier";
      return d.toLocaleDateString("fr-FR");
    }

    function renderTripsTable(){
      const el = document.querySelector("#tripsBody");
      if(!el) return;

      const rows = trips.length
        ? trips.map(t => `
          <tr>
            <td>${escapeHtml(fmtDateLabel(t.created_at))}</td>
            <td><b>${escapeHtml(shortId(t.id))}</b></td>
            <td>${escapeHtml(t.pickup_zone || "‚Äî")}</td>
            <td>${renderTripStatus(t.status)}</td>
            <td><b>${fmtMoney(t.amount || 0)}</b></td>
          </tr>
        `).join("")
        : `<tr><td colspan="5" class="tiny" style="padding:12px">Aucune course pour le moment.</td></tr>`;

      el.innerHTML = rows;

      const counter = document.querySelector("#tripsCount");
      if(counter) counter.textContent = String(trips.length);
    }

    function upsertTripLocal(row){
      const idx = trips.findIndex(x => x.id === row.id);
      if(idx >= 0) trips[idx] = { ...trips[idx], ...row };
      else trips.unshift(row);
    }
    function removeTripLocal(row){
      trips = trips.filter(x => x.id !== row.id);
    }

    async function loadTrips(){
      const userId = sessionUser?.id;
      if(!userId) return [];

      const { data, error } = await supabase
        .from("driver_trips")
        .select("id,status,pickup_zone,amount,created_at")
        .eq("auth_user_id", userId)
        .order("created_at", { ascending: false })
        .limit(50);

      if(error){
        console.log("loadTrips error:", error);
        return [];
      }
      return data || [];
    }

    function stopTripsRealtime(){
      if(tripsChannel){
        try{ supabase.removeChannel(tripsChannel); }catch(e){}
        tripsChannel = null;
      }
    }

    function startTripsRealtime(){
      const userId = sessionUser?.id;
      if(!userId) return;

      stopTripsRealtime();

      tripsChannel = supabase
        .channel("driver_trips_" + userId)
        .on("postgres_changes",
          { event: "INSERT", schema: "public", table: "driver_trips", filter: `auth_user_id=eq.${userId}` },
          (payload) => { upsertTripLocal(payload.new); renderTripsTable(); }
        )
        .on("postgres_changes",
          { event: "UPDATE", schema: "public", table: "driver_trips", filter: `auth_user_id=eq.${userId}` },
          (payload) => { upsertTripLocal(payload.new); renderTripsTable(); }
        )
        .on("postgres_changes",
          { event: "DELETE", schema: "public", table: "driver_trips", filter: `auth_user_id=eq.${userId}` },
          (payload) => { removeTripLocal(payload.old); renderTripsTable(); }
        )
        .subscribe((status) => {
          console.log("Realtime trips status:", status);
        });
    }

    async function createTripTest(){
      const userId = sessionUser?.id;
      if(!userId){
        toast("#saveMsg","‚ùå Pas connect√©.","bad");
        return;
      }

      const payload = {
        auth_user_id: userId,
        status: "pending",
        pickup_city: "Dakar",
        pickup_zone: "Saly Centre",
        dropoff_city: "Dakar",
        dropoff_zone: "Ngaparou",
        distance_km: 10,
        fare_base: 1500,
        fare_per_km: 350,
        client_label: "Client (priv√©)"
      };

      const { error } = await supabase.from("driver_trips").insert(payload);
      if(error){
        toast("#saveMsg","‚ùå Insert trip: " + escapeHtml(error.message),"bad");
        return;
      }
      toast("#saveMsg","‚úÖ Course test cr√©√©e (tu dois la voir pop en live).","ok");
    }

    async function setLatestTripStatus(nextStatus){
      const userId = sessionUser?.id;
      if(!userId || !trips.length){
        toast("#saveMsg","‚ÑπÔ∏è Aucune course √† modifier.","ok");
        return;
      }
      const latest = trips[0];

      const { error } = await supabase
        .from("driver_trips")
        .update({ status: nextStatus })
        .eq("id", latest.id)
        .eq("auth_user_id", userId);

      if(error){
        toast("#saveMsg","‚ùå Update trip: " + escapeHtml(error.message),"bad");
        return;
      }
      toast("#saveMsg","‚úÖ Statut mis √† jour: " + escapeHtml(nextStatus),"ok");
    }

    // --- UI renderers
    function renderLogin(messageHtml=""){
      $("#app").innerHTML = `
        <div class="wrap">
          <div class="top">
            <div class="brand">
              <div class="logo">ü¶Ö</div>
              <div>
                <h1>DIGIY DRIVER PRO</h1>
                <p>Connexion Chauffeur ‚Ä¢ 0% commission</p>
              </div>
            </div>
            <div class="actions">
              <span class="pill"><span class="dot"></span> Non connect√©</span>
            </div>
          </div>

          <div class="center">
            <div class="card login">
              <div class="hero">
                <h2>Bienvenue, Chauffeur ‚ú®</h2>
                <p>Connexion par <b>t√©l√©phone</b> (OTP).<br/>Terrain first, rapide, propre.</p>
              </div>
              <div class="bd">
                ${messageHtml ? `<div class="msg">${messageHtml}</div><div class="sep"></div>` : ""}

                <div class="row">
                  <div>
                    <label>T√©l√©phone (format international)</label>
                    <input id="phone" placeholder="+221771342889" inputmode="tel" autocomplete="tel" />
                    <div class="tiny" style="margin-top:6px">Ex: +2217xxxxxxx</div>
                  </div>
                  <div>
                    <label>Module</label>
                    <select id="module">
                      <option value="driver">DRIVER</option>
                      <option value="loc">LOC</option>
                      <option value="resto">RESTO</option>
                      <option value="market">MARKET</option>
                    </select>
                    <div class="tiny" style="margin-top:6px">Ici on est sur DRIVER.</div>
                  </div>
                </div>

                <div class="sep"></div>

                <div class="otpgrid">
                  <button class="btn primary" id="btnSendOtp">Envoyer le code OTP</button>
                  <div>
                    <label>Code OTP</label>
                    <input id="otp" placeholder="123456" inputmode="numeric" autocomplete="one-time-code" />
                  </div>
                </div>

                <div class="stack" style="margin-top:10px">
                  <button class="btn" id="btnVerify">Valider & entrer</button>
                  <button class="btn" id="btnHelp">Aide</button>
                </div>

                <div id="loginMsg" style="margin-top:10px"></div>

                <div class="sep"></div>
                <div class="tiny">
                  Mode test : Supabase ‚Üí Auth ‚Üí Phone ‚Üí Test Phone Numbers (ex: 221771342889=123456).
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      $("#btnHelp").onclick = () => {
        $("#loginMsg").innerHTML = `
          <div class="msg">
            üß† Test rapide :<br/>
            - Dans Supabase: <b>221771342889=123456</b> (sans +)<br/>
            - Ici: <b>+221771342889</b><br/>
            - OTP: <b>123456</b><br/>
            Le code g√®re test + prod automatiquement.
          </div>
        `;
      };

      $("#btnSendOtp").onclick = sendOtp;
      $("#btnVerify").onclick = verifyOtp;
    }

    function renderTripStatus(s){
      const x = String(s || "").toLowerCase();

      if(x === "completed" || x === "done") return `<span class="badge b-ok">‚úÖ Termin√©</span>`;
      if(x === "started") return `<span class="badge b-warn">üöï En course</span>`;
      if(x === "accepted") return `<span class="badge b-warn">‚úÖ Accept√©</span>`;
      if(x === "pending") return `<span class="badge b-warn">‚è≥ En attente</span>`;
      if(x === "cancelled" || x === "canceled" || x === "cancel") return `<span class="badge b-idle">üö´ Annul√©</span>`;

      return `<span class="badge b-idle">‚Äî</span>`;
    }

    function renderDashboard(profile){
      const connectedDot = `<span class="pill"><span class="dot ok"></span> Connect√©</span>`;
      const who = profile?.full_name || "Chauffeur DIGIY";
      const phone = profile?.phone || sessionUser?.phone || "‚Äî";

      $("#app").innerHTML = `
        <div class="wrap">
          <div class="top">
            <div class="brand">
              <div class="logo">ü¶Ö</div>
              <div>
                <h1>DIGIY DRIVER PRO</h1>
                <p>Espace Chauffeur ‚Ä¢ Paiement direct ‚Ä¢ 0% commission</p>
              </div>
            </div>
            <div class="actions">
              ${connectedDot}
              <button class="btn danger" id="btnLogout">D√©connexion</button>
            </div>
          </div>

          <div class="grid">
            <!-- Profil -->
            <div class="card">
              <div class="hd">
                <div>
                  <h2>Profil Chauffeur</h2>
                  <small>Nom, zone, disponibilit√©, tarifs ‚Äî modifiable.</small>
                </div>
                <div class="right">
                  <span class="badge b-ok">‚úÖ PRO</span>
                </div>
              </div>
              <div class="bd">
                <div class="msg ok">
                  üëã <b>${escapeHtml(who)}</b> ‚Ä¢ <span class="tiny">${escapeHtml(phone)}</span>
                </div>

                <div class="sep"></div>

                <div class="row">
                  <div>
                    <label>Nom affich√©</label>
                    <input id="full_name" value="${escapeHtml(profile?.full_name || "")}" placeholder="Ex: Lamine Chauffeur" />
                  </div>
                  <div>
                    <label>T√©l√©phone</label>
                    <input id="phone_ro" value="${escapeHtml(phone || "")}" disabled />
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Ville</label>
                    <input id="city" value="${escapeHtml(profile?.city || "Dakar")}" placeholder="Dakar" />
                  </div>
                  <div>
                    <label>Zone</label>
                    <input id="zone" value="${escapeHtml(profile?.zone || "Saly / Petite C√¥te")}" placeholder="Saly Centre" />
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Disponibilit√©</label>
                    <select id="status">
                      <option value="available">‚úÖ Disponible</option>
                      <option value="busy">‚è≥ En course</option>
                      <option value="offline">üåô Hors ligne</option>
                    </select>
                  </div>
                  <div>
                    <label>Type v√©hicule</label>
                    <select id="vehicle_type">
                      <option value="car">üöó Voiture</option>
                      <option value="moto">üèçÔ∏è Moto</option>
                      <option value="van">üöê Van</option>
                    </select>
                  </div>
                </div>

                <div class="sep"></div>

                <h3 style="margin:0 0 8px;font-family:Outfit,Manrope,sans-serif;font-size:15px">Tarifs (terrain)</h3>
                <div class="row">
                  <div>
                    <label>Prix d√©part (prise en charge)</label>
                    <input id="fare_base" type="number" min="0" value="${Number(profile?.fare_base ?? 1500)}" />
                    <div class="tiny" style="margin-top:6px">${fmtMoney(profile?.fare_base ?? 1500)}</div>
                  </div>
                  <div>
                    <label>Prix / km</label>
                    <input id="fare_per_km" type="number" min="0" value="${Number(profile?.fare_per_km ?? 350)}" />
                    <div class="tiny" style="margin-top:6px">${fmtMoney(profile?.fare_per_km ?? 350)} / km</div>
                  </div>
                </div>

                <div class="stack" style="margin-top:12px">
                  <button class="btn primary" id="btnSave">Enregistrer</button>
                  <button class="btn" id="btnRefresh">Rafra√Æchir</button>
                </div>

                <div id="saveMsg" style="margin-top:10px"></div>
              </div>
            </div>

            <!-- Trips realtime -->
            <div class="card">
              <div class="hd">
                <div>
                  <h2>Activit√© (Realtime)</h2>
                  <small>Courses Supabase ‚Ä¢ mises √† jour instantan√©es.</small>
                </div>
                <div class="right">
                  <span class="badge b-idle">üßæ <span id="tripsCount">0</span> entr√©es</span>
                </div>
              </div>
              <div class="bd">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>ID</th>
                      <th>Zone</th>
                      <th>Statut</th>
                      <th>Montant</th>
                    </tr>
                  </thead>
                  <tbody id="tripsBody"></tbody>
                </table>

                <div class="sep"></div>

                <div class="stack">
                  <button class="btn" id="btnTripTest">+ Course test</button>
                  <button class="btn" id="btnTripStart">Statut: started</button>
                  <button class="btn" id="btnTripDone">Statut: completed</button>
                </div>

                <div class="tiny" style="margin-top:8px">
                  ‚ö° Ces boutons servent √† v√©rifier le Realtime. Apr√®s, on branche le vrai flux client‚Üíchauffeur.
                </div>

                <div class="sep"></div>
                <div class="msg">
                  Si tu ne vois rien : active Realtime sur <b>public.driver_trips</b> dans Supabase, et v√©rifie que la table existe + RLS OK.
                </div>
              </div>
            </div>

          </div>
        </div>
      `;

      $("#status").value = profile?.status || "available";
      $("#vehicle_type").value = profile?.vehicle_type || "car";

      $("#btnLogout").onclick = logout;
      $("#btnSave").onclick = saveProfile;
      $("#btnRefresh").onclick = refreshProfile;

      // Trips buttons
      $("#btnTripTest").onclick = createTripTest;
      $("#btnTripStart").onclick = () => setLatestTripStatus("started");
      $("#btnTripDone").onclick = () => setLatestTripStatus("completed");
    }

    // --- AUTH (OTP) ‚Äî TEST + PROD AUTO
    async function sendOtp(){
      const phoneUi = safe($("#phone").value);

      if(!isValidPhone(phoneUi)){
        toast("#loginMsg", "‚ùå Num√©ro invalide (ex: +2217xxxxxxx).", "bad");
        return;
      }

      const pNoPlus = phoneNoPlus(phoneUi);
      const pPlus = phoneE164(phoneUi);

      toast("#loginMsg", "‚è≥ Envoi OTP‚Ä¶", "");

      try{
        let res = await supabase.auth.signInWithOtp({ phone: pNoPlus });
        if(res?.error){
          res = await supabase.auth.signInWithOtp({ phone: pPlus });
        }
        if(res?.error){
          toast("#loginMsg", "‚ùå Erreur OTP : " + escapeHtml(res.error.message), "bad");
          return;
        }
        toast("#loginMsg", "‚úÖ OTP envoy√©. Entre le code (test: 123456).", "ok");
      }catch(e){
        toast("#loginMsg", "‚ùå Exception : " + escapeHtml(e.message || e), "bad");
      }
    }

    async function verifyOtp(){
      const phoneUi = safe($("#phone").value);
      const token = safe($("#otp").value);

      if(!phoneUi || !token){
        toast("#loginMsg", "‚ùå T√©l√©phone + code OTP requis.", "bad");
        return;
      }
      if(!isValidPhone(phoneUi)){
        toast("#loginMsg", "‚ùå Num√©ro invalide.", "bad");
        return;
      }

      const pNoPlus = phoneNoPlus(phoneUi);
      const pPlus = phoneE164(phoneUi);

      toast("#loginMsg", "‚è≥ V√©rification‚Ä¶", "");

      try{
        let res = await supabase.auth.verifyOtp({ phone: pNoPlus, token, type: "sms" });
        if(res?.error){
          res = await supabase.auth.verifyOtp({ phone: pPlus, token, type: "sms" });
        }
        if(res?.error){
          toast("#loginMsg", "‚ùå OTP invalide : " + escapeHtml(res.error.message), "bad");
          return;
        }

        sessionUser = res.data?.user || null;
        toast("#loginMsg", "‚úÖ Connect√© ! Chargement‚Ä¶", "ok");
        await boot(true);
      }catch(e){
        toast("#loginMsg", "‚ùå Exception : " + escapeHtml(e.message || e), "bad");
      }
    }

    async function logout(){
      stopTripsRealtime();
      try{ await supabase.auth.signOut(); }catch(e){}
      sessionUser = null;
      trips = [];
      renderLogin("D√©connect√© ‚úÖ");
    }

    // --- Profile storage strategy (V2)
    const LS_KEY = "digiy_driver_profile_v2";

    function getLocalProfile(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }

    function setLocalProfile(p){
      try{ localStorage.setItem(LS_KEY, JSON.stringify(p)); }catch(e){}
    }

    async function loadProfile(){
      const local = getLocalProfile() || {};
      const base = {
        full_name: local.full_name || "",
        phone: local.phone || (sessionUser?.phone || ""),
        city: local.city || "Dakar",
        zone: local.zone || "Saly / Petite C√¥te",
        status: local.status || "available",
        vehicle_type: local.vehicle_type || "car",
        fare_base: Number(local.fare_base ?? 1500),
        fare_per_km: Number(local.fare_per_km ?? 350)
      };

      try{
        const userId = sessionUser?.id;
        if(!userId) return base;

        const { data, error } = await supabase
          .from("driver_profiles")
          .select("*")
          .eq("auth_user_id", userId)
          .maybeSingle();

        if(error) return base;

        if(data){
          const merged = {
            ...base,
            full_name: data.full_name ?? base.full_name,
            phone: data.phone ?? base.phone,
            city: data.city ?? base.city,
            zone: data.zone ?? base.zone,
            status: data.status ?? base.status,
            vehicle_type: data.vehicle_type ?? base.vehicle_type,
            fare_base: Number(data.fare_base ?? base.fare_base),
            fare_per_km: Number(data.fare_per_km ?? base.fare_per_km)
          };
          setLocalProfile(merged);
          return merged;
        }

        return base;
      }catch(e){
        return base;
      }
    }

    async function saveProfile(){
      const profile = {
        full_name: safe($("#full_name").value),
        phone: safe($("#phone_ro").value),
        city: safe($("#city").value),
        zone: safe($("#zone").value),
        status: $("#status").value,
        vehicle_type: $("#vehicle_type").value,
        fare_base: Number($("#fare_base").value || 0),
        fare_per_km: Number($("#fare_per_km").value || 0)
      };

      setLocalProfile(profile);

      try{
        const userId = sessionUser?.id;
        if(!userId){
          toast("#saveMsg", "‚úÖ Enregistr√© (local).", "ok");
          return;
        }

        const payload = {
          auth_user_id: userId,
          ...profile,
          updated_at: new Date().toISOString()
        };

        const { error } = await supabase
          .from("driver_profiles")
          .upsert(payload, { onConflict: "auth_user_id" });

        if(error){
          toast("#saveMsg", "‚úÖ Enregistr√© (local). DB pas pr√™te : " + escapeHtml(error.message), "ok");
          return;
        }
        toast("#saveMsg", "‚úÖ Enregistr√© (local + DB).", "ok");
      }catch(e){
        toast("#saveMsg", "‚úÖ Enregistr√© (local).", "ok");
      }
    }

    async function refreshProfile(){
      toast("#saveMsg", "‚è≥ Rafra√Æchissement‚Ä¶", "");
      const p = await loadProfile();
      renderDashboard(p);

      // Reload trips too
      trips = await loadTrips();
      renderTripsTable();
      startTripsRealtime();

      toast("#saveMsg", "‚úÖ OK.", "ok");
    }

    // --- Boot (SAFE)
    async function boot(afterVerify=false){
      try{
        const { data, error } = await supabase.auth.getUser();

        if(error || !data?.user){
          stopTripsRealtime();
          sessionUser = null;
          trips = [];
          renderLogin(afterVerify ? "Session non d√©tect√©e. R√©essaie." : "");
          return;
        }

        sessionUser = data.user;

        const profile = await loadProfile();
        renderDashboard(profile);

        // Load trips + realtime
        trips = await loadTrips();
        renderTripsTable();
        startTripsRealtime();

        supabase.auth.onAuthStateChange(async (_event, newSession) => {
          if(!newSession?.user){
            stopTripsRealtime();
            sessionUser = null;
            trips = [];
            renderLogin("Session expir√©e. Reconnecte-toi.");
          } else {
            sessionUser = newSession.user;
            // Re-attach realtime for this user (au cas o√π)
            trips = await loadTrips();
            renderTripsTable();
            startTripsRealtime();
          }
        });
      }catch(e){
        stopTripsRealtime();
        sessionUser = null;
        trips = [];
        renderLogin("Erreur chargement. Recharge la page (Cmd+Shift+R).");
      }
    }

    // Start
    renderLogin("");
    boot();
  </script>
</body>
</html>
